<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine 專案戰情室 (人員視角版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Helper Functions ---
        const isToday = (dateString) => {
            if (!dateString) return false;
            const today = new Date();
            const date = new Date(dateString);
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        };

        const isPast = (dateString) => {
            if (!dateString) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const date = new Date(dateString);
            return date < today;
        };

        // Helper: Check if status is closed
        const isClosed = (statusName) => {
            if (!statusName) return false;
            const s = statusName.toLowerCase();
            return s === 'closed' || s === 'resolved' || s === 'rejected' || s.includes('已解決') || s.includes('結案') || s.includes('關閉');
        };

        const getBaseUrl = (inputUrl) => {
            try {
                const urlObj = new URL(inputUrl);
                return urlObj.origin; 
            } catch (e) {
                return inputUrl.replace(/\/$/, '');
            }
        };

        const getStatusColor = (status) => {
            const s = status.toLowerCase();
            if (s === 'new' || s === '新建') return 'bg-blue-100 text-blue-800 border-blue-200';
            if (s.includes('progress') || s.includes('進行')) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
            if (s === 'closed' || s === 'resolved' || s.includes('已解決') || s.includes('結案') || s.includes('關閉')) return 'bg-slate-100 text-slate-500 border-slate-200';
            if (s === 'feedback' || s.includes('回饋')) return 'bg-purple-100 text-purple-800 border-purple-200';
            return 'bg-slate-50 text-slate-700 border-slate-200';
        };

        // --- Icons ---
        const Icon = ({ d, className, color }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ color }}>
                {d}
            </svg>
        );
        const Icons = {
            Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
            Alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            List: <><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
            Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
            ChevronDown: <polyline points="6 9 12 15 18 9"></polyline>
        };

        const Main = () => {
            // --- State ---
            const safeGet = (k, d) => localStorage.getItem(k) || d;
            
            const [config, setConfig] = useState({
                url: safeGet('redmine_url', 'https://igs.redmine-x.com'),
                apiKey: safeGet('redmine_apiKey', ''),
                projectId: safeGet('redmine_projectId', '')
            });
            const [proxyMode, setProxyMode] = useState(safeGet('redmine_proxyMode', 'public'));
            const [showSettings, setShowSettings] = useState(false);
            const [issues, setIssues] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            
            // New State for User Filtering
            const [selectedUserId, setSelectedUserId] = useState('me'); 
            const [availableUsers, setAvailableUsers] = useState([]);

            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            // UI Filters: 'all' (open), 'today', 'overdue', 'closed'
            const [filterType, setFilterType] = useState('all'); 

            // --- Effects ---
            useEffect(() => {
                localStorage.setItem('redmine_url', config.url);
                localStorage.setItem('redmine_apiKey', config.apiKey);
                localStorage.setItem('redmine_projectId', config.projectId);
                localStorage.setItem('redmine_proxyMode', proxyMode);
            }, [config, proxyMode]);

            // --- Fetch Logic ---
            const fetchData = async () => {
                if (!config.apiKey) { setError('請先輸入 API Token'); return; }
                setLoading(true); setError(null);

                try {
                    // Quick Proxy Implementation
                    const fetchAPI = async (path) => {
                        // status_id=* to get ALL issues including closed ones
                        // limit=100 is standard default max.
                        const target = `${config.url}${path}${path.includes('?')?'&':'?'}key=${config.apiKey}&limit=100&status_id=*`;
                        const url = proxyMode === 'direct' ? target : 
                                   `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`;
                        const res = await fetch(url, proxyMode === 'direct' ? { headers: {'X-Redmine-API-Key': config.apiKey}} : {});
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return await res.json();
                    };

                    const [userRes, issuesRes] = await Promise.all([
                        fetchAPI('/users/current.json'),
                        fetchAPI('/issues.json')
                    ]);
                    
                    setCurrentUser(userRes.user);
                    setIssues(issuesRes.issues);

                    // Extract unique users from issues for the dropdown
                    const usersMap = new Map();
                    // Add current user first
                    if(userRes.user) {
                        usersMap.set(userRes.user.id, userRes.user.firstname + ' ' + userRes.user.lastname);
                    }
                    // Add users found in issues
                    issuesRes.issues.forEach(issue => {
                        if (issue.assigned_to) {
                            usersMap.set(issue.assigned_to.id, issue.assigned_to.name);
                        }
                    });
                    
                    const userList = Array.from(usersMap, ([id, name]) => ({ id, name }));
                    setAvailableUsers(userList);
                    
                    // Default to current user
                    setSelectedUserId(userRes.user.id);

                } catch (err) {
                    setError(err.message === 'HTTP 401' ? 'API Token 無效' : '連線失敗，請檢查網址或嘗試不同連線模式');
                } finally {
                    setLoading(false);
                }
            };

            // --- Filtering Logic (Dynamic User) ---
            const filteredIssues = useMemo(() => {
                // First, filter by the SELECTED user from dropdown
                // If selectedUserId is 'all', we show everything (optional feature), but let's stick to personal focus
                let targetIssues = issues;
                
                if (selectedUserId && selectedUserId !== 'all') {
                    // Convert both to string or number to match safely
                    targetIssues = issues.filter(i => i.assigned_to?.id == selectedUserId);
                } else if (currentUser && selectedUserId === 'me') {
                     targetIssues = issues.filter(i => i.assigned_to?.id === currentUser.id);
                }

                // Case 1: Viewing "Closed" tab
                if (filterType === 'closed') {
                    return targetIssues.filter(i => isClosed(i.status?.name));
                }

                // Case 2: Viewing active tabs (All Pending, Today, Overdue)
                // Exclude closed issues
                let activeIssues = targetIssues.filter(i => !isClosed(i.status?.name));

                if (filterType === 'today') {
                    return activeIssues.filter(i => isToday(i.due_date));
                }
                if (filterType === 'overdue') {
                    return activeIssues.filter(i => isPast(i.due_date));
                }
                
                // 'all' means 'all active' for this user
                return activeIssues;
            }, [issues, filterType, selectedUserId, currentUser]);

            // --- Helper for Counts (Dynamic User) ---
            const getCounts = () => {
                let targetIssues = issues;
                if (selectedUserId && selectedUserId !== 'all') {
                    targetIssues = issues.filter(i => i.assigned_to?.id == selectedUserId);
                } else if (currentUser && selectedUserId === 'me') {
                    targetIssues = issues.filter(i => i.assigned_to?.id === currentUser.id);
                } else if (!currentUser && issues.length === 0) {
                     return { all: 0, today: 0, overdue: 0, closed: 0 };
                }

                const active = targetIssues.filter(i => !isClosed(i.status?.name));
                
                return {
                    all: active.length,
                    today: active.filter(i => isToday(i.due_date)).length,
                    overdue: active.filter(i => isPast(i.due_date)).length,
                    closed: targetIssues.filter(i => isClosed(i.status?.name)).length
                };
            };
            
            const counts = getCounts();

            // Find selected user name for display
            const selectedUserName = useMemo(() => {
                if (!selectedUserId) return '';
                const u = availableUsers.find(u => u.id == selectedUserId);
                return u ? u.name : 'Unknown';
            }, [selectedUserId, availableUsers]);

            // --- UI Components ---
            const StatCard = ({ label, val, color, icon, active, onClick }) => (
                <div onClick={onClick} className={`bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer transition-all hover:shadow-md ${active ? 'ring-2 ring-blue-500 bg-blue-50' : ''}`}>
                    <div className="flex justify-between items-center">
                        <div>
                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{label}</p>
                            <p className={`text-2xl font-bold mt-1 ${color}`}>{val}</p>
                        </div>
                        <div className={`p-2 rounded-lg bg-slate-100 text-slate-400`}>
                            <Icon d={icon} className="w-5 h-5" />
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-12">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="bg-slate-900 text-white p-2 rounded-lg">
                                        <Icon d={Icons.Activity} className="w-5 h-5" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg font-bold text-slate-800">專案戰情室</h1>
                                        {currentUser && (
                                            <p className="text-xs text-slate-500 flex items-center gap-1">
                                                Hi, {currentUser.firstname} 
                                                <span className="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full text-[10px]">
                                                    檢視: {selectedUserName}
                                                </span>
                                            </p>
                                        )}
                                    </div>
                                </div>

                                <div className="flex items-center gap-2">
                                    <input 
                                        type="password" 
                                        placeholder="輸入 Token" 
                                        className="bg-slate-50 border border-slate-200 rounded px-3 py-1.5 text-sm w-32 focus:w-48 transition-all outline-none focus:ring-2 focus:ring-blue-500"
                                        value={config.apiKey}
                                        onChange={e => setConfig({...config, apiKey: e.target.value})}
                                    />
                                    
                                    <button 
                                        onClick={fetchData} 
                                        disabled={loading}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-bold flex items-center gap-2"
                                    >
                                        {loading ? '讀取中...' : <><Icon d={Icons.Search} className="w-4 h-4" /> 分析</>}
                                    </button>

                                    <button 
                                        onClick={() => setShowSettings(!showSettings)}
                                        className={`p-2 rounded text-slate-400 hover:bg-slate-100 ${showSettings ? 'text-blue-600 bg-blue-50' : ''}`}
                                    >
                                        <Icon d={Icons.Settings} className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            {/* Collapsible Settings */}
                            {showSettings && (
                                <div className="mt-3 pt-3 border-t border-slate-100 flex gap-4 animate-fadeIn">
                                    <div className="flex-1">
                                        <label className="text-xs text-slate-500 block mb-1">Redmine 網址</label>
                                        <input 
                                            className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-sm text-slate-600"
                                            value={config.url}
                                            onChange={e => setConfig({...config, url: e.target.value})}
                                        />
                                    </div>
                                    <div className="w-48">
                                        <label className="text-xs text-slate-500 block mb-1">連線模式</label>
                                        <select 
                                            className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-sm text-slate-600"
                                            value={proxyMode}
                                            onChange={e => setProxyMode(e.target.value)}
                                        >
                                            <option value="public">公共 Proxy (推薦)</option>
                                            <option value="direct">直連 (需 CORS 套件)</option>
                                        </select>
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6 space-y-8">
                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2">
                                <Icon d={Icons.Alert} className="w-5 h-5" /> {error}
                            </div>
                        )}

                        {/* Main Content */}
                        {issues.length > 0 ? (
                            <section className="animate-fadeIn">
                                {/* Toolbar: User Selector */}
                                <div className="flex justify-end mb-4">
                                    <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                                        <Icon d={Icons.User} className="w-4 h-4 text-slate-400" />
                                        <span className="text-xs text-slate-500">檢視人員:</span>
                                        <select 
                                            className="text-sm font-bold text-slate-700 outline-none bg-transparent cursor-pointer min-w-[120px]"
                                            value={selectedUserId}
                                            onChange={(e) => {
                                                setSelectedUserId(e.target.value);
                                                setFilterType('all'); // Reset filter when user changes
                                            }}
                                        >
                                            {availableUsers.map(u => (
                                                <option key={u.id} value={u.id}>{u.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {/* Stats - 4 Columns for Personal View */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <StatCard 
                                        label={`${selectedUserName} 的待辦`} 
                                        val={counts.all} 
                                        color="text-slate-800" 
                                        icon={Icons.List} 
                                        active={filterType === 'all'}
                                        onClick={() => setFilterType('all')}
                                    />
                                    <StatCard 
                                        label="今日待辦" 
                                        val={counts.today} 
                                        color="text-blue-600" 
                                        icon={Icons.Clock} 
                                        active={filterType === 'today'}
                                        onClick={() => setFilterType('today')}
                                    />
                                    <StatCard 
                                        label="逾期案件" 
                                        val={counts.overdue} 
                                        color="text-red-600" 
                                        icon={Icons.Alert} 
                                        active={filterType === 'overdue'}
                                        onClick={() => setFilterType('overdue')}
                                    />
                                    <StatCard 
                                        label="已結案" 
                                        val={counts.closed} 
                                        color="text-slate-400" 
                                        icon={Icons.CheckCircle} 
                                        active={filterType === 'closed'}
                                        onClick={() => setFilterType('closed')}
                                    />
                                </div>

                                {/* List */}
                                <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                                    <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            {filterType === 'all' ? '待辦案件列表' : 
                                             filterType === 'today' ? '今日到期案件' : 
                                             filterType === 'overdue' ? '逾期案件列表' : 
                                             '已結案歷史紀錄'}
                                            <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">
                                                {selectedUserName}
                                            </span>
                                        </h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                                <tr>
                                                    <th className="px-6 py-3">#</th>
                                                    <th className="px-6 py-3">狀態</th>
                                                    <th className="px-6 py-3 w-1/3">主題</th>
                                                    <th className="px-6 py-3">負責人</th>
                                                    <th className="px-6 py-3">期限</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredIssues.map(issue => {
                                                    const isOverdue = isPast(issue.due_date) && !isClosed(issue.status?.name);
                                                    return (
                                                        <tr key={issue.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="px-6 py-4 font-mono text-blue-600 font-bold">
                                                                <a href={`${config.url}/issues/${issue.id}`} target="_blank" className="hover:underline">#{issue.id}</a>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <span className={`px-2 py-1 rounded text-xs font-bold ${getStatusColor(issue.status.name)}`}>
                                                                    {issue.status.name}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 font-medium text-slate-700">
                                                                <div className="text-xs text-slate-400 mb-0.5">{issue.project?.name}</div>
                                                                {issue.subject}
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-600">
                                                                        {issue.assigned_to?.name.charAt(0)}
                                                                    </div>
                                                                    <span className="text-slate-600">{issue.assigned_to?.name}</span>
                                                                </div>
                                                            </td>
                                                            <td className={`px-6 py-4 ${isOverdue ? 'text-red-600 font-bold' : 'text-slate-500'}`}>
                                                                {issue.due_date || '-'}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                        {filteredIssues.length === 0 && (
                                            <div className="p-8 text-center text-slate-400">
                                                {currentUser ? `沒有符合條件的案件 (${selectedUserName})` : '請先登入'}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </section>
                        ) : (
                            // Welcome / Empty State
                            !loading && (
                                <div className="flex flex-col items-center justify-center py-20 text-center animate-fadeIn">
                                    <div className="bg-white p-4 rounded-full shadow-sm mb-6">
                                        <Icon d={Icons.Activity} className="w-12 h-12 text-slate-300" />
                                    </div>
                                    <h2 className="text-xl font-bold text-slate-700 mb-2">準備開始工作</h2>
                                    <p className="text-slate-500 max-w-md mb-8">
                                        請在上方輸入您的 Redmine API Token 即可取得資料。
                                    </p>
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Main />);
    </script>
</body>
</html>